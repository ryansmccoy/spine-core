# Justfile for market-spine-basic
# Install just: https://github.com/casey/just
# Usage: just <recipe>

# Default recipe - show available commands
default:
    @just --list

# Install dependencies
install:
    uv sync

# Install with dev dependencies
dev:
    uv sync
    uv run pre-commit install

# Build schema from modules
schema-build:
    python ../scripts/build_schema.py

# Initialize database
db-init:
    uv run spine db init

# Reset database (WARNING: deletes all data)
db-reset:
    uv run spine db reset --yes
    uv run spine db init

# Run tests
test:
    uv run pytest tests/ -v

# Run tests with coverage
coverage:
    uv run pytest tests/ --cov=src --cov-report=term-missing --cov-report=html
    @echo "Coverage report: htmlcov/index.html"

# Run linter
lint:
    uv run ruff check src tests ../packages/spine-core/src ../packages/spine-domains-otc/src

# Format code
format:
    uv run ruff format src tests ../packages/spine-core/src ../packages/spine-domains-otc/src
    uv run ruff check --fix src tests ../packages/spine-core/src ../packages/spine-domains-otc/src

# Type check
typecheck:
    uv run mypy src/ --ignore-missing-imports

# Run all checks (lint + typecheck + test)
check: lint typecheck test

# Run pre-commit on all files
pre-commit:
    uv run pre-commit run --all-files

# List available pipelines
list:
    uv run spine list

# Run a pipeline (example: just run otc.ingest_week file_path=data/fixtures/otc/week_2025-12-19.psv tier=NMS_TIER_1)
run pipeline *args:
    uv run spine run {{pipeline}} {{args}}

# Start interactive shell
shell:
    uv run spine shell

# Show system status
status:
    uv run spine status

# Clean build artifacts
clean:
    rm -rf build/ dist/ *.egg-info/ .pytest_cache/ .ruff_cache/ .mypy_cache/ htmlcov/ .coverage
    find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true

# Build packages
build:
    uv build
